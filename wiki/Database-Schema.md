# Database Schema

## Overview
The application uses **H2 in-memory database** with JPA/Hibernate for ORM. The schema supports profile management and order processing with tax calculations.

## Entity Relationship Diagram

```
┌─────────────┐         ┌──────────────┐
│   PROFILES  │         │    ORDERS    │
├─────────────┤         ├──────────────┤
│ id (PK)     │◄────────┤ user_id (FK) │
│ name        │    1:N  │ id (PK)      │
│ email       │         │ created_date │
│ password_hash│         │ updated_date │
│ created_date│         └──────────────┘
│ last_login  │                │
│ active      │                │ 1:N
└─────────────┘                ▼
                    ┌──────────────────┐
                    │ ORDER_ITEMS      │
                    │ (Embedded)       │
                    ├──────────────────┤
                    │ product_id       │
                    │ quantity         │
                    │ sku_id           │
                    │ unit_price       │
                    │ sgst_rate        │
                    │ cgst_rate        │
                    └──────────────────┘
```

## Table Definitions

### 📋 PROFILES Table
**Purpose**: Store user account information

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | BIGINT | PRIMARY KEY | Unique user identifier |
| `name` | VARCHAR(255) | NOT NULL | User's full name |
| `email` | VARCHAR(255) | NOT NULL, UNIQUE | Email address (login) |
| `password_hash` | VARCHAR(255) | NOT NULL | Encrypted password |
| `created_date` | TIMESTAMP | NOT NULL | Account creation time |
| `last_login_date` | TIMESTAMP | NULL | Last successful login |
| `active` | BOOLEAN | NOT NULL, DEFAULT TRUE | Account status |

**Indexes**:
- Primary: `id`
- Unique: `email`

**Sample Data**:
```sql
INSERT INTO PROFILES VALUES 
(1, 'John Doe', 'john@example.com', 'hashed_password123', 
 '2024-01-15 10:30:00', '2024-01-15 11:00:00', true);
```

### 📦 ORDERS Table
**Purpose**: Store order header information

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | BIGINT | PRIMARY KEY | Unique order identifier |
| `user_id` | BIGINT | NOT NULL, FOREIGN KEY | Owner of the order |
| `created_date` | TIMESTAMP | NOT NULL | Order creation time |
| `updated_date` | TIMESTAMP | NOT NULL | Last modification time |

**Foreign Keys**:
- `user_id` → `PROFILES(id)`

**Indexes**:
- Primary: `id`
- Foreign: `user_id`

**Sample Data**:
```sql
INSERT INTO ORDERS VALUES 
(123, 1, '2024-01-15 12:00:00', '2024-01-15 12:30:00');
```

### 🛒 ORDER_ITEMS Collection
**Purpose**: Store individual items within orders (embedded collection)

**Table Name**: `ORDERS_ORDER_ITEMS` (auto-generated by JPA)

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `order_entity_id` | BIGINT | FOREIGN KEY | Parent order ID |
| `product_id` | BIGINT | NOT NULL | Product identifier |
| `quantity` | INTEGER | NOT NULL | Number of items |
| `sku_id` | VARCHAR(255) | NOT NULL | Stock keeping unit |
| `unit_price` | DECIMAL(19,2) | NOT NULL | Price per unit |
| `sgst_rate` | DECIMAL(5,2) | NOT NULL | State GST percentage |
| `cgst_rate` | DECIMAL(5,2) | NOT NULL | Central GST percentage |

**Foreign Keys**:
- `order_entity_id` → `ORDERS(id)`

**Sample Data**:
```sql
INSERT INTO ORDERS_ORDER_ITEMS VALUES 
(123, 1, 2, 'SKU001', 100.00, 9.00, 9.00);
```

## JPA Entity Mappings

### Profile Entity
```java
@Entity
@Table(name = "profiles")
public class ProfileEntity {
    @Id
    private Long id;
    
    @Column(name = "email", unique = true)
    private String email;
    
    // ... other fields
}
```

### Order Entity
```java
@Entity
@Table(name = "orders")
public class OrderEntity {
    @Id
    private Long id;
    
    @Column(name = "user_id")
    private Long userId;
    
    @ElementCollection
    private List<OrderItemEntity> orderItems;
    
    // ... other fields
}
```

### OrderItem Embeddable
```java
@Embeddable
public class OrderItemEntity {
    @Column(name = "product_id")
    private Long productId;
    
    @Column(name = "unit_price")
    private BigDecimal unitPrice;
    
    // ... other fields
}
```

## Database Configuration

### H2 Configuration
```properties
# In-memory database
spring.datasource.url=jdbc:h2:mem:testdb
spring.datasource.driverClassName=org.h2.Driver
spring.datasource.username=sa
spring.datasource.password=

# Auto-create schema
spring.jpa.hibernate.ddl-auto=create-drop
spring.jpa.show-sql=true

# H2 Console access
spring.h2.console.enabled=true
```

### Schema Generation
**Strategy**: `create-drop`
- Creates tables on startup
- Drops tables on shutdown
- Suitable for development/testing

**SQL Logging**: Enabled for debugging
```properties
spring.jpa.show-sql=true
logging.level.org.hibernate.SQL=DEBUG
```

## Data Access Patterns

### Repository Pattern
```java
public interface JpaOrderRepository extends JpaRepository<OrderEntity, Long> {
    Optional<OrderEntity> findByUserId(Long userId);
    List<OrderEntity> findByUserIdOrderByCreatedDateDesc(Long userId);
}
```

### Query Examples
```java
// Find orders by user
List<OrderEntity> userOrders = repository.findByUserId(userId);

// Find recent orders
List<OrderEntity> recent = repository.findTop10ByOrderByCreatedDateDesc();

// Custom query
@Query("SELECT o FROM OrderEntity o WHERE o.userId = ?1 AND o.createdDate > ?2")
List<OrderEntity> findRecentOrdersByUser(Long userId, LocalDateTime since);
```

## Performance Considerations

### Indexing Strategy
- **Primary Keys**: Automatic clustering
- **Foreign Keys**: Automatic indexing
- **Email**: Unique constraint with index
- **User Orders**: Consider composite index on (user_id, created_date)

### Query Optimization
```sql
-- Efficient user order lookup
CREATE INDEX idx_orders_user_created ON ORDERS(user_id, created_date DESC);

-- Email lookup optimization (automatic with UNIQUE)
CREATE UNIQUE INDEX idx_profiles_email ON PROFILES(email);
```

### Connection Pooling
```properties
# HikariCP configuration (default in Spring Boot)
spring.datasource.hikari.maximum-pool-size=10
spring.datasource.hikari.minimum-idle=5
spring.datasource.hikari.connection-timeout=20000
```

## Data Migration (Future)

### Flyway Integration
```xml
<dependency>
    <groupId>org.flywaydb</groupId>
    <artifactId>flyway-core</artifactId>
</dependency>
```

### Migration Scripts
```sql
-- V1__Initial_schema.sql
CREATE TABLE profiles (
    id BIGINT PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    email VARCHAR(255) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    created_date TIMESTAMP NOT NULL,
    last_login_date TIMESTAMP,
    active BOOLEAN NOT NULL DEFAULT TRUE
);

-- V2__Add_orders.sql
CREATE TABLE orders (
    id BIGINT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    created_date TIMESTAMP NOT NULL,
    updated_date TIMESTAMP NOT NULL,
    FOREIGN KEY (user_id) REFERENCES profiles(id)
);
```

## Production Database Options

### PostgreSQL
```properties
spring.datasource.url=jdbc:postgresql://localhost:5432/dddapp
spring.datasource.username=ddduser
spring.datasource.password=password
spring.jpa.database-platform=org.hibernate.dialect.PostgreSQLDialect
```

### MySQL
```properties
spring.datasource.url=jdbc:mysql://localhost:3306/dddapp
spring.datasource.username=ddduser
spring.datasource.password=password
spring.jpa.database-platform=org.hibernate.dialect.MySQL8Dialect
```

## Backup and Recovery

### H2 Database Backup
```sql
-- Export data
SCRIPT TO 'backup.sql';

-- Import data
RUNSCRIPT FROM 'backup.sql';
```

### Production Backup Strategy
- **Regular Snapshots**: Daily automated backups
- **Transaction Log Backup**: Continuous backup for point-in-time recovery
- **Cross-Region Replication**: Disaster recovery
- **Testing**: Regular restore testing